<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<title>テニスキャンセル待ち</title>
<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwS7J3e5zFwFYttrhglkjQGH7-Aj15ogcDsDFgV54To7QSGCCEA/exec";
function myLoad() {
	var recTable = new Vue({
		el: '#app'
		, data: {
			records:null
			, dateOpts:[]
			, times:['h09', 'h11', 'h13', 'h15', 'h17', 'h19']
			, isLoading:true
			, updateIndex:null
			, updateId:null
			, updateTitle:null
			, updateTimes:null
		}
		, methods: {
			// ["h09", "h11"] → "09時, 19時"
			formatCheckTimes(hours) {
				return hours.map(hour => hour.substring(1) + "時").join(", ");
			}
			, processError(error) {
				this.isLoading = false;
				alert("エラーが発生しました。" + error.message);
			}
			, load() {
				fetch(GAS_URL + '?rest=1')
				.then(response => {
					if (response.ok) {
						return response.json();
					}
					throw new Error("情報の取得に失敗しました。");
				})
				.then(json => this.records = json.records)
				.catch(error => this.processError(error))
				.finally(() => this.isLoading = false);
			}
			, deleteEntry(index) {
				const rec = this.records[index];
				if (!confirm(rec.title + " を削除してよろしいですか?")) {
					return;
				}
				const id = rec.id;
				const formData = new FormData();
				formData.append('p_command', 'delete');
				formData.append('p_rest', '1');
				formData.append('p_entry', id);
				this.isLoading = true;
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: formData
				}).then(response => {
					if (response.ok) {
						this.records.splice(index, 1);
						this.isLoading = false;
						return;
					}
					throw new Error("削除時にエラーが発生しました。" + response);
				}).catch(error => this.processError(error))
			}
			, postNew() {
				this.isLoading = true;
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: new FormData(form_new_entry)
				}).then(response => {
					if (response.ok) {
						this.load();
						return;
					}
					throw new Error("登録時にエラーが発生しました。" + response);
				}).catch(error => this.processError(error))
			}
			, updateEntry(index) {
				const rec = this.records[index];
				this.updateIndex = index;
				this.updateId = rec.id;
				this.updateTitle = rec.title;
				this.updateTimes = rec.times;
				$('#dlgUpdateEntry').modal();
			}
			, postUpdate() {
				this.isLoading = true;
				this.updateTimes.sort();	// 定義順にならない(クリック順みたい)
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: new FormData(form_update_entry)
				}).then(response => {
					if (response.ok) {
						this.records[this.updateIndex].times = this.updateTimes;
						this.isLoading = false;
						return;
					}
					throw new Error("時間行進時にエラーが発生しました。" + response);
				}).catch(error => this.processError(error))
			}
		}
		, created() {
			const week = ["日", "月", "火", "水", "木", "金", "土"];
			const dt = new Date();
			for (let i = 0; i < 31; i++) {
				const month = dt.getMonth() + 1;
				const date = dt.getDate();
				const weekStr = week[dt.getDay()];
				const className = (weekStr == "土")? "sat": ((weekStr == "日")? "san": "");
				const text = month + "/" + date + "(" + weekStr + ")";
				const val = dt.getFullYear() + "-" + ("0" + month).slice(-2) + "-" + ("0" + date).slice(-2) + "," + text;
				this.dateOpts.push({value:val, text:text, className:className});
				dt.setDate(dt.getDate() + 1);
			}
			this.load();
		}
	});
}
</script>
<style>
select[name="p_date"] option.sat {
	background-color:#ddf;
}
select[name="p_date"] option.san {
	background-color:#fdd;
}
tbody#d_rec_table tr:nth-child(-n+4) {
	background-color:#bff;
}
table.table td, table.table th {
	padding:2px;
}

.loader,
.loader:after {
  border-radius: 50%;
  width: 10em;
  height: 10em;
}
.loader {
  margin: 60px auto;
  font-size: 10px;
  position: relative;
  text-indent: -9999em;
  border-top: 1.1em solid rgba(53,53,53, 0.2);
  border-right: 1.1em solid rgba(53,53,53, 0.2);
  border-bottom: 1.1em solid rgba(53,53,53, 0.2);
  border-left: 1.1em solid #353535;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-animation: load8 1.1s infinite linear;
  animation: load8 1.1s infinite linear;
}
@-webkit-keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes load8 {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -webkit-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
</style>
</head>
<body onload="myLoad();">
<div id="app">
<div v-if="isLoading" class="loader"></div>
<div v-else="isLoading">
	<!-- メイン画面 -->
	<table class="table table-bordered">
		<thead class="thead-dark">
			<tr>
				<th scope="col">日付と場所</th>
				<th scope="col">時間帯</th>
				<th scope="col">操作</th>
			</tr>
		</thead>
		<tbody id="d_rec_table">
			<tr v-for="(rec, index) in records">
				<td>{{rec.title}}</td>
				<td>{{formatCheckTimes(rec.times)}}</td>
				<td>
					<button type="button" class="btn btn-secondary" v-on:click="updateEntry(index)">変更</button>
					<button type="button" class="btn btn-secondary" v-on:click="deleteEntry(index)">削除</button>
				</td>
			</tr>
		</tbody>
	</table>
	<button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#newEntry">新規登録</button>

	<!-- 新規登録ダイアログ -->
	<div class="modal fade" id="newEntry" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">新規登録</h5>
				</div>
				<div class="modal-body">
					<form name="form_new_entry">
						<div class="row">
							<label class="col-form-label col-3">日付</label>
							<div class="col">
								<select name="p_date">
									<option v-for="date in dateOpts" v-bind:value="date.value" v-bind:class="date.className">{{date.text}}</option>
								</select>
							</div>
						</div>
						<div class="row">
							<label class="col-form-label col-3">時間帯</label>
							<div class="col">
								<div class="form-check" v-for="time in times">
									<input class="form-check-input" type="checkbox" name="p_time" v-bind:value="time" v-bind:id="'chk' + time">
									<label class="form-check-label" v-bind:for="'chk' + time">{{formatCheckTimes([time])}}</label>
								</div>
							</div>
						</div>
						<div class="row border-top" style="margin-top:6px;padding-top:6px">
							<label class="col-form-label col-3">施設</label>
							<div class="col">
								<label><input type="radio" name="p_place" value="ao" checked>青木町</label><br>
								<label><input type="radio" name="p_place" value="ns">西スポ</label><br>
								<label><input type="radio" name="p_place" value="nk">西公民館</label><br>
							</div>
						</div>
						<input type="hidden" name="p_command" value="entry">
						<input type="hidden" name="p_rest" value="1">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal" v-on:click="postNew">　登　録　</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
				</div>
			</div>
		</div>
	</div>

	<!-- 変更ダイアログ -->
	<div class="modal fade" id="dlgUpdateEntry" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">{{updateTitle}}</h5>
				</div>
				<div class="modal-body">
					<form name="form_update_entry">
						<div class="row">
							<label class="col-form-label col-3">時間帯</label>
							<div class="col">
								<div class="form-check" v-for="time in times">
									<input class="form-check-input" type="checkbox" name="p_update_time" v-bind:value="time" v-bind:id="'chk' + time" v-model="updateTimes">
									<label class="form-check-label" v-bind:for="'chk' + time">{{formatCheckTimes([time])}}</label>
								</div>
							</div>
						</div>
						<input type="hidden" name="p_command" value="update">
						<input type="hidden" name="p_update_id" v-bind:value="updateId">
						<input type="hidden" name="p_update_title" v-bind:value="updateTitle">
						<input type="hidden" name="p_rest" value="1">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal" v-on:click="postUpdate">　変　更　</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
				</div>
			</div>
		</div>
	</div>

</div>
</div>

<!-- Bootstrap.jp -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
