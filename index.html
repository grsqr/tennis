<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<link rel="stylesheet" href="loader.css">
<title>ãƒ†ãƒ‹ã‚¹ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡</title>
<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwS7J3e5zFwFYttrhglkjQGH7-Aj15ogcDsDFgV54To7QSGCCEA/exec";
function myLoad() {
/*
	10åˆ†ã§æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ãªã®ã§ã„ã£ãŸã‚“å‰Šé™¤

	// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚Šæ›´æ–°ã•ã‚Œãªã„å¯¾ç­–
	// ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿vã®å¾Œã«ã¤ã‘ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¦‹ã¦ã€ç¾åœ¨æ—¥æ™‚ã‚ˆã‚Š3åˆ†ä»¥ä¸Šå¤ã‘ã‚Œã°
	// ç¾åœ¨æ—¥æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã¤ã‘ã¦ãƒªãƒ­ãƒ¼ãƒ‰
	const query = location.search;
	const v = /\?v=([0-9]+)\&?/.exec(query);
	if ((v != null) && ((Date.now() - 3000 * 60) < v[1])) {
		// ok
	} else {
		const newUrl = location.href.substring(0, location.href.length - query.length) + "?v=" + Date.now();
		location.replace(newUrl);
		return;
	}
*/
	var recTable = new Vue({
		el: '#app'
		, data: {
			records:null
			, dateOpts:[]
			, times:['h09', 'h11', 'h13', 'h15', 'h17', 'h19']
			, isLoading:true
			, updateIndex:null
			, updateId:null
			, updateTitle:null
			, updateTimes:null
		}
		, methods: {
			// ["h09", "h11"] â†’ "09æ™‚, 19æ™‚"
			formatCheckTimes(hours) {
				const emoji = {
					'h09':'ğŸ•˜'
					, 'h11':'ğŸ•š'
					, 'h13':'ğŸ•'
					, 'h15':'ğŸ•’'
					, 'h17':'ğŸ•”'
					, 'h19':'ğŸ•–'
				};
				return hours.map(hour => emoji[hour] + hour.substring(1) + "æ™‚").join("<br>");
			}
			, processError(error) {
				this.isLoading = false;
				alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" + error.message);
			}
			, load() {
				fetch(GAS_URL + '?rest=1')
				.then(response => {
					if (response.ok) {
						return response.json();
					}
					throw new Error("æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
				})
				.then(json => this.records = json.records)
				.catch(error => this.processError(error))
				.finally(() => this.isLoading = false);
			}
			, deleteEntry(index) {
				const rec = this.records[index];
				if (!confirm(rec.title + " ã‚’å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹?")) {
					return;
				}
				const id = rec.id;
				const formData = new FormData();
				formData.append('p_command', 'delete');
				formData.append('p_rest', '1');
				formData.append('p_entry', id);
				this.isLoading = true;
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: formData
				}).then(response => {
					if (response.ok) {
						this.records.splice(index, 1);
						this.isLoading = false;
						return;
					}
					throw new Error("å‰Šé™¤æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" + response);
				}).catch(error => this.processError(error))
			}
			, postNew() {
				if (!this.isCheckTimes(form_new_entry.p_time)) return false;
				$('#newEntry').modal('hide');
				this.isLoading = true;
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: new FormData(form_new_entry)
				}).then(response => {
					if (response.ok) {
						this.load();
						return;
					}
					throw new Error("ç™»éŒ²æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" + response);
				}).catch(error => {
					this.processError(error);
				})
			}
			, updateEntry(index) {
				const rec = this.records[index];
				this.updateIndex = index;
				this.updateId = rec.id;
				this.updateTitle = rec.title;
				this.updateTimes = rec.times;
				$('#dlgUpdateEntry').modal();
			}
			, postUpdate() {
				if (!this.isCheckTimes(form_update_entry.p_update_time)) return false;
				$('#dlgUpdateEntry').modal('hide');
				this.isLoading = true;
				this.updateTimes.sort();	// å®šç¾©é †ã«ãªã‚‰ãªã„(ã‚¯ãƒªãƒƒã‚¯é †ã¿ãŸã„)
				fetch(GAS_URL, {
					method: "post"
					, headers: {'accept': 'application/json'}
					, body: new FormData(form_update_entry)
				}).then(response => {
					if (response.ok) {
						this.records[this.updateIndex].times = this.updateTimes;
						this.isLoading = false;
						return;
					}
					throw new Error("æ™‚é–“è¡Œé€²æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚" + response);
				}).catch(error => this.processError(error))
			}
			, isCheckTimes(timesCtrls) {
				for (let i = 0, len = timesCtrls.length; i < len; i++) {
					if (timesCtrls[i].checked) {
						return true;
					}
				}
				alert("æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
				return false;
			}
		}
		, created() {
			const week = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
			const dt = new Date();
			for (let i = 0; i < 31; i++) {
				const month = dt.getMonth() + 1;
				const date = dt.getDate();
				const weekStr = week[dt.getDay()];
				const className = (weekStr == "åœŸ")? "sat": ((weekStr == "æ—¥")? "san": "");
				const text = month + "/" + date + "(" + weekStr + ")";
				const val = dt.getFullYear() + "-" + ("0" + month).slice(-2) + "-" + ("0" + date).slice(-2) + "," + text;
				this.dateOpts.push({value:val, text:text, className:className});
				dt.setDate(dt.getDate() + 1);
			}
			this.load();
		}
	});
}
</script>
<style>
select[name="p_date"] option.sat {
	background-color:#ddf;
}
select[name="p_date"] option.san {
	background-color:#fdd;
}
tbody#d_rec_table tr:nth-child(-n+3) {
	background-color:#bff;
}
table#main_table {
  border-collapse:collapse;
  border-spacing:0;
  margin-bottom:2px;
}
table#main_table th {
  background-color:#ccc;
  border:1px solid #000;
  font-weight:normal;
  text-align:center;
}
table#main_table td {
  padding:3px;
  border:1px solid #000;
}
</style>
</head>
<body onload="myLoad();">
<div id="app">
<div v-if="isLoading" class="loader"></div>
<div v-else="isLoading">
	<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
	<div style="padding:2px;">
		<table id="main_table">
			<thead>
				<tr>
					<th>æ—¥ä»˜ã¨å ´æ‰€</th>
					<th>æ™‚é–“å¸¯</th>
					<th>æ“ä½œ</th>
				</tr>
			</thead>
			<tbody id="d_rec_table">
				<tr v-for="(rec, index) in records">
					<td>{{rec.title}}</td>
					<td v-html="formatCheckTimes(rec.times)"></td>
					<td>
						<button type="button" class="btn btn-secondary" v-on:click="updateEntry(index)">å¤‰æ›´</button>
						<button type="button" class="btn btn-secondary" v-on:click="deleteEntry(index)">å‰Šé™¤</button>
					</td>
				</tr>
			</tbody>
		</table>
		<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newEntry">æ–°è¦ç™»éŒ²</button>
	</div>

	<!-- æ–°è¦ç™»éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
	<div class="modal fade" id="newEntry" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">æ–°è¦ç™»éŒ²</h5>
				</div>
				<div class="modal-body">
					<form name="form_new_entry">
						<div class="row">
							<label class="col-form-label col-3">æ—¥ä»˜</label>
							<div class="col">
								<select name="p_date">
									<option v-for="date in dateOpts" v-bind:value="date.value" v-bind:class="date.className">{{date.text}}</option>
								</select>
							</div>
						</div>
						<div class="row">
							<label class="col-form-label col-3">æ™‚é–“å¸¯</label>
							<div class="col">
								<div class="form-check" v-for="time in times">
									<input class="form-check-input" type="checkbox" name="p_time" v-bind:value="time" v-bind:id="'chk' + time">
									<label class="form-check-label" v-bind:for="'chk' + time">{{formatCheckTimes([time])}}</label>
								</div>
							</div>
						</div>
						<div class="row border-top" style="margin-top:6px;padding-top:6px">
							<label class="col-form-label col-3">æ–½è¨­</label>
							<div class="col">
								<label><input type="radio" name="p_place" value="ao" checked>é’æœ¨ç”º</label><br>
								<label><input type="radio" name="p_place" value="ns">è¥¿ã‚¹ãƒ</label><br>
								<label><input type="radio" name="p_place" value="nk">è¥¿å…¬æ°‘é¤¨</label><br>
							</div>
						</div>
						<input type="hidden" name="p_command" value="entry">
						<input type="hidden" name="p_rest" value="1">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" v-on:click="postNew">ã€€ç™»ã€€éŒ²ã€€</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
				</div>
			</div>
		</div>
	</div>

	<!-- å¤‰æ›´ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
	<div class="modal fade" id="dlgUpdateEntry" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-sm" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">{{updateTitle}}</h5>
				</div>
				<div class="modal-body">
					<form name="form_update_entry">
						<div class="row">
							<label class="col-form-label col-3">æ™‚é–“å¸¯</label>
							<div class="col">
								<div class="form-check" v-for="time in times">
									<input class="form-check-input" type="checkbox" name="p_update_time" v-bind:value="time" v-bind:id="'chk' + time" v-model="updateTimes">
									<label class="form-check-label" v-bind:for="'chk' + time">{{formatCheckTimes([time])}}</label>
								</div>
							</div>
						</div>
						<input type="hidden" name="p_command" value="update">
						<input type="hidden" name="p_update_id" v-bind:value="updateId">
						<input type="hidden" name="p_update_title" v-bind:value="updateTitle">
						<input type="hidden" name="p_rest" value="1">
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" v-on:click="postUpdate">ã€€å¤‰ã€€æ›´ã€€</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
				</div>
			</div>
		</div>
	</div>

</div>
</div>

<!-- Bootstrap.jp -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
